#script to gather Leaf Area data and create SLA data set.
#Code created by Florian Christ as part of the Master Thesis 13.04.2025
#used R Version. 4.4.1 2024-06-14 ucrt


#00_Setup_Environment######
#import libraries
library(tidyverse)
library(openxlsx)
library(ggplot2)



#load project functions
source("./03_R/00_functions.R")

#01. load all the area data from the csv files distributed in the 01_SLA_Pictures folder. #####


# Set the path to your folder containing the CSV files
folder_path <- "../10_Lab/00_Bern"


# Recursively list all CSV files
csv_files <- list.files(path = folder_path, pattern = "Areas\\.csv$", recursive = TRUE, full.names = TRUE)


# Apply function to all files and bind into one DataFrame
leaf_area_data <- csv_files %>%
  lapply(load_csv_and_add_filename_to_col) %>%
  bind_rows()


#2. Calculate SLA####
#prepare leaf area data for SLA calculation
leaf_area_data_clean <- leaf_area_data %>% 
  select(-c(source_file,Min,Max,Mean)) %>% 
  rename("leaf_nr"="...1") %>% 
  relocate(sample_name,.before = 1) 
  
  
leaf_area_data_mean_per_replicate <- leaf_area_data_clean %>% 
  group_by(sample_name,replicate) %>% 
  summarise(leaf_area = mean(Area)) %>% 
  ungroup()

leaf_area_mean_rp <- plot_prepr(leaf_area_data_mean_per_replicate)
  
  

#import leaf weight
plant_leaf_weight <- read.xlsx("./01_input/Plant_Health.xlsx",sheet = "SLA")

#clean_leaf_weight, prepare leaf area data for SLA calculation
plant_leaf_weigt_clean <- plant_leaf_weight %>% 
  select(1:2) %>% 
  rename("sample_name"="Code","weight_g"="Weight.[g]") %>% 
  filter(!str_ends(sample_name,"_r")) %>% 
  mutate(replicate = substr(sample_name,7,7),.after = sample_name) %>% 
  mutate(sample_name = substr(sample_name,1,5))

plant_leaf_weight_rp <- plot_prepr(plant_leaf_weigt_clean) %>% 
  mutate(replicate=as.double(replicate)) %>% 
  select(-c(7,8))


sla_calc_ready <- leaf_area_mean_rp %>% 
  left_join(plant_leaf_weight_rp,by=c("sample_name","location","farming_system","plot","replicate"))

sla_data <- sla_calc_ready %>% 
  mutate(sla = leaf_area/weight_g)

write.xlsx(sla_data,paste0("./02_output/sla_data",today,".xlsx"))
saveRDS(sla_data,"./01_input/sla_data_clean.rds")
  
