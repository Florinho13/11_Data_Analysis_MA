#script for soil texture analysis
#Code created by Florian Christ as part of the Master Thesis
#used R Version. 4.4.1 2024-06-14 ucrt


#00_Setup_Environment######
#import libraries
library(tidyverse)
library(ggplot2)


#load project functions
source("./03_R/00_functions.R")

#import datasets
ph_clean <- readRDS("./01_input/pH_data_clean.rds")
microbial_c_clean <- readRDS("./01_input/microbialC_data_clean.rds")
microbial_n_clean <- readRDS("./01_input/microbialN_data_clean.rds")


# prepare dataset for plotting#####
#pH
ph_clean_rp <- plot_prepr(ph_clean)

#microbial C
microbial_c_clean_rp <- plot_prepr(microbial_c_clean)

#microbial N
microbial_n_clean_rp <- plot_prepr(microbial_n_clean)

#01.2 Basic analysis of pH values
summary(ph_clean_rp$pH)

#02 create overview plots#####
location_colors <- map_colours(ph_clean_rp$location) #create colour map vector

#pH overview plot
#don't use as this generates mean values based on the pH and not on Hplus concentration.
#pH_plot_overview <- overview_plot(ph_clean_rp,sample_name,ph_clean_rp$pH,ph_clean_rp$shape,ph_clean_rp$location,"pH","Field Numbers","pH value",location_colors)
#pH_plot_overview

# pH_plot_overview with corrected mean pH based on Hplus concentration
pH_plot_overview <- ggplot(ph_clean_rp,aes(x=substr(sample_name,1,3),y=ph_clean_rp$pH,pch=factor(ph_clean_rp$shape),colour = factor(ph_clean_rp$location)))+
  geom_point(stat = "identity", position = "identity")+
  ggtitle(paste("pH values on the different field plots\
          and field average"))+
  labs(y="pH value",x="Field Numbers")+
  stat_summary(
    fun = function(x) { 
      mean_Hplus <- mean(10^(-x))  # Step 1: Convert pH to H+ concentration, then compute the mean
      -log10(mean_Hplus)  # Step 2: Convert mean H+ back to pH
    },  
    geom = "point",
    aes(shape = "Mean Value"),
    shape = 8,
    color = "black",  
    size = 2
  ) +# Thickness of the line
  scale_color_manual(values = location_colors , labels = c("Freudwil","Niederhasli","LÃ¤ufelfingen",
                                                   "Heimenhausen","Heimiswil","Ueberstorf"))+
  scale_shape_manual(values = c(16,17), labels = c("Regenerative","Conventional"))+
  labs(color = "Location",shape="Farming System")+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        axis.title = element_text(size = 14),  # Axis title size
        axis.text = element_text(size = 12,angle=45),
        legend.title = element_text(size = 14),  # Legend title size
        legend.text = element_text(size = 12))
pH_plot_overview

ggsave("./02_output/pH_overview_correct.png",pH_plot_overview,width = 15,height = 15,units = "cm")


#microbial C overview plot
microbial_c_overview <- overview_plot(microbial_c_clean_rp,microbial_c_clean_rp$sample_name,
                                      microbial_c_clean_rp$microbial_c,microbial_c_clean_rp$shape,
                                      microbial_c_clean_rp$location,"Microbial C","Field Numbers","mg/kg dry mass",location_colors)
microbial_c_overview
ggsave("./02_output/microbial_c_overview.png",microbial_c_overview,width = 15,height = 15,units = "cm")


#microbial N overview plot
microbial_n_overview <- overview_plot(microbial_n_clean_rp,microbial_n_clean_rp$sample_name,
                                      microbial_n_clean_rp$microbial_N,microbial_n_clean_rp$shape,
                                      microbial_n_clean_rp$location,"Microbial N","Field Numbers","mg/kg dry mass",location_colors)

microbial_n_overview
ggsave("./02_output/microbial_n_overview.png",microbial_n_overview,width = 15,height = 15,units = "cm")

